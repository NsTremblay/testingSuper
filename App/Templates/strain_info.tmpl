<!DOCTYPE html>
<html>

<TMPL_INCLUDE NAME="header.tmpl">

<TMPL_INCLUDE NAME="nav_bar_strain_info.tmpl">

<body onload="onLoadCheck()" style="background-color:#796e6c">

	<div class="container" style="background-color:#FFFFFF">

		<div class="row-fluid" style="margin:10px 10px 10px 10px;padding:10px 10px 10px 10px">
			
			<h1><span>STRAIN</span> <span style="color:#d41616">INFORMATION</span></h1>
		</div>

		<div class="row-fluid">
			<TMPL_INCLUDE NAME="strain_info_form.tmpl">

			<TMPL_IF strainData>
			<div class="span8">
				<ul id="strainInfoTabs" class="nav nav-tabs" style="display:none">
					<li class="active"><a href="#overviewTab" data-toggle="tab">Overview</a></li>
					<li><a href="#phyloTreeTab" data-toggle="tab">Phylogenetic Tree</a></li>
					<li><a href="#virAmrTab" data-toggle="tab">Virulence and AMR</a></li>
					<TMPL_IF references>
					<li><a href="#refTab" data-toggle="tab">References</a></li>
					</TMPL_IF>
					<TMPL_IF comments>
					<li><a href="#commentTab" data-toggle="tab">Notes</a></li>
					</TMPL_IF>
				</ul>

				<div class="tab-content">
					<TMPL_INCLUDE NAME="strain_info_overview_tab.tmpl">

					<div class="tab-pane" id="phyloTreeTab">
						<div id="svgCanvas" style="padding:5px">
							<TMPL_INCLUDE NAME="phylogeny_strain_info.tmpl">
						</div>
					</div>

					<div class="tab-pane" id="virAmrTab">
						<div class="row-fluid" id="strainInfoDiv" style="margin:10px 10px 10px 0px">
							<div class="span6" style="height:300px;overflow:auto;margin-top:10px">
								<table class="table table-striped table-condensed">
									<thead></thead>
									<tr>
										<th>Virulence Factors</th>
									</tr>
									<TMPL_LOOP NAME=VIRDATA><tr><td><button id="vir_amr_link" class="btn btn-small btn-link" value="<TMPL_VAR NAME=feature_id>" onclick="showVFMetaInfo(this)"><TMPL_VAR NAME=gene_name></a></td></tr></TMPL_LOOP>
								</table>
							</div>
							<div class="span6" style="height:300px;overflow:auto;margin-top:10px">
								<table class="table table-striped table-condensed">
									<thead></thead>
									<tr>
										<th>AMR Genes</th>
									</tr>
									<TMPL_LOOP NAME=AMRDATA><tr><td><button id="vir_amr_link" class="btn btn-small btn-link" value="<TMPL_VAR NAME=feature_id>" onclick="showAMRMetaInfo(this)"><TMPL_VAR NAME=gene_name></a></td></tr></TMPL_LOOP>
								</table>
							</div>
						</div>

						<div class="row-fluid">
							<div id="VFMetaInfo" class="span6" style="border-style:solid;border-width:1px;border-color:#d3d3d3;margin:10px 5px 10px 0px;padding:10px;height:300px;overflow:auto">Individual VIR Data goes here</div>
							<div id="AMRMetaInfo" class="span6" style="border-style:solid;border-width:1px;border-color:#d3d3d3;margin:10px 0px 10px 5px;padding:10px;height:300px;overflow:auto">Individual AMR Data Goes here</div>
						</div>

					</div>

					<TMPL_IF references>
					<div class="tab-pane" id="refTab" style="margin:10px 10px 10px 0px">
						<TMPL_IF owners>
						<div class="row-fluid">
							<div class="span11">
								<span class="muted">Original submitter / Owner of genome: </span>
							</div>
							<div class="span11">
								<ol>
									<TMPL_LOOP owners>
									<li><TMPL_VAR owner></li>
									</TMPL_LOOP>
								</ol>
							</div>
						</div>
						<hr>
						</TMPL_IF>

						<TMPL_IF pmids>
						<div class="row-fluid">
							<div class="span11">
								<span class="muted">Pubmed References: </span>
							</div>
							<div class="span11">
								<ol>
									<TMPL_LOOP pmids>
									<li><TMPL_VAR pmid></li>
									</TMPL_LOOP>
								</ol>
							</div>
						</div>
						</TMPL_IF>
					</div>
					</TMPL_IF>

					<TMPL_IF comments>
					<div class="tab-pane" id="commentTab" style="margin:10px 10px 10px 0px">
						<div class="row-fluid">
							<ol>
								<TMPL_LOOP comments>
								<li><TMPL_VAR comment></li>
								</TMPL_LOOP>
							</ol>
						</div>
					</div>
					</TMPL_IF>
				</div>
			</div>
			</TMPL_IF>
			
		</div>
	</div>

</body>

<TMPL_INCLUDE NAME="footer.tmpl">

</html>

<script type="text/javascript">


function showVFMetaInfo(tag) {
	$('#VFMetaInfo').empty();
	$('#VFMetaInfo').append('<div class="span5" id="wheel-loader" style="margin:10px 0px 0px 0px"><small><em><img src="/App/Pictures/wheel-loader.gif"> Loading Info...</em></small></div>');

	$.post("/vf_meta_info", { VFName: tag.getAttribute("value")},  
		function(vir){
			$('#VFMetaInfo').empty();
			$('#VFMetaInfo').append('<div class="span7"><h4>'+vir.data[0].gene_name+' ('+vir.data[0].uniquename+') '+'</h4></div>');

			for (var i = 1; i < vir.data.length; i++) {
				$('#VFMetaInfo').append('<div class="span12" style="margin:20px 0px 5px 20px"><span class="text-info" id="vfTerms"><strong>' + vir.data[i].term_name + '</strong></span></div><div class="span12"><ol><li style="padding-left:10px">' + vir.data[i].value + '</li></ol></div>');
			}

		}, "json" , $('#VFMetaInfo').show());
}

function showAMRMetaInfo(tag) {
	$('#AMRMetaInfo').empty();
	$('#AMRMetaInfo').append('<div class="span5" id="wheel-loader" style="margin:10px 0px 0px 0px"><small><em><img src="/App/Pictures/wheel-loader.gif"> Loading Info...</em></small></div>');
	$.post("/amr_meta_info",  { AMRName: tag.getAttribute("value")},  
		function(amr){
			$('#AMRMetaInfo').empty();
			
			var amrhtml = '<div class="span9"><h4>'+amr.data.name+'</h4></div>';
			
			if(amr.data.synonyms.length > 0) {
				amrhtml += 
				'<div class="span3"><span class="muted" style="padding-left:20px;">Synonyms: </span></div>';
				amrhtml += '<div class="span9">';
				for(var i = 0; i < amr.data.synonyms.length; i++) {
					amrhtml += '<span style="padding-left:10px">'+amr.data.synonyms[i]+'</span>';
				}
				amrhtml += '</div>';
			}
			
			$('#AMRMetaInfo').append(amrhtml);
			
			if(amr.data.descriptions.length > 0) {

				var defhtml =
				'<div class="span12" style="margin:20px 0px 5px 20px"><span class="text-info"><strong>Description</strong></span></div>'+
				'<div class="span12"><ol>';
				
				for(var j = 0; j < amr.data.descriptions.length; j++) {
					defhtml += '<li style="padding-left:10px">'+amr.data.descriptions[j]+'</li>'
				}
				
				defhtml += '</ol></div>';
				$('#AMRMetaInfo').append(defhtml);
			}
			
			if(amr.data.aro_terms.length > 0) {

				var arohtml =
				'<div class="span12" style="margin:20px 0px 5px 20px"><span class="text-info"><strong>Antimicrobial Resistance Ontology Annotations</strong></span></div>'+
				'<div class="span12"><ol>';
				
				for(var j = 0; j < amr.data.aro_terms.length; j++) {
					arohtml += '<li style="padding-left:10px"><strong>'+amr.data.aro_terms[j].accession+' '+amr.data.aro_terms[j].term_name+
					'</strong><br>'+amr.data.aro_terms[j].term_defn+'</li>'
				}
				
				arohtml += '</ol></div>';
				$('#AMRMetaInfo').append(arohtml);
			}
			
			//$('#AMRMetaInfo').append('</div>');

		}, "json" , $('#AMRMetaInfo').show());
}

var FEATURE_TABLE_JSON = <TMPL_VAR NAME=strainJSONData>;
/* 
Back lists that will get called to the client after page has loaded.
These remain as global constants.
*/
var ISOLATION_LOCATION_JSON = {};
var SEROTYPE_JSON = {};
var ISOLATION_HOST_JSON = {};
var ISOLATION_SOURCE_JSON = {};
var ISOLATION_DATE_JSON = {};

//List of public feature ids used to get data for view switching 
var featureIdList = "";
$(document).ready(function() {
	for (i=0 ; i<FEATURE_TABLE_JSON.data.length-1 ; i++) {
		featureIdList = featureIdList + String(FEATURE_TABLE_JSON.data[i].feature_id) + ",";
	}
	featureIdList = featureIdList + String(FEATURE_TABLE_JSON.data[FEATURE_TABLE_JSON.data.length-1].feature_id);
});

function onLoadCheck() {
	$('#strainInfoTabs').show("slow");
	initialize();
}

function initialize() {

	getPublicList("/serotype_form" , SEROTYPE_JSON, 'serotypeViewLabel', 'serotypeView', 'genodo_serotype');
	getPublicList("/host_source_form" , ISOLATION_HOST_JSON, 'isolationHostLabel', 'isolationHostView', 'genodo_isolation_host');
	getPublicList("/isolation_source_form" , ISOLATION_SOURCE_JSON, 'isolationSourceLabel', 'isolationSourceView', 'genodo_isolation_source');
	getPublicList("/isolation_date_form" , ISOLATION_DATE_JSON, 'isolationDateLabel', 'isolationDateView', 'genodo_isolation_date');
	getPublicList('/isolation_location_form' , ISOLATION_LOCATION_JSON, 'isolationLocationLabel', 'isolationLocationView', 'genodo_isolation_location');

}

function getPublicList(urlName,formType,labelId,radioId,typeName) {

	if(sessionStorage[typeName]  == null) {
		// Get list from server and save in local storage
		$.ajax({
			type: "POST",
			url: urlName,
			data: { public_id_list: featureIdList }
		}).done(function (returned_data) {
			sessionStorage[typeName] = returned_data;
			formType.json = $.parseJSON(returned_data);
			$('#'+radioId).attr('disabled',false);
			$('#'+labelId+'Loading').hide();
			$('#'+labelId).show();
		});
	} else {
		formType.json = $.parseJSON(sessionStorage[typeName]);
		$('#'+radioId).attr('disabled',false);
		$('#'+labelId+'Loading').hide();
		$('#'+labelId).show();
	}
}

/*
The next functions are for switching form views:
*/

$('#commonNameView').click(function () {
	showCommonNames(FEATURE_TABLE_JSON);
});
$('#accessionNumberView').click(function () {
	showAccessionNumbers(FEATURE_TABLE_JSON);
});
$('#isolationHostView').click(function () {
	changeListView(ISOLATION_HOST_JSON.json);
});
$('#isolationSourceView').click(function () {
	changeListView(ISOLATION_SOURCE_JSON.json);
});
$('#serotypeView').click(function () {
	changeListView(SEROTYPE_JSON.json);
});
$('#isolationDateView').click(function () {
	changeListView(ISOLATION_DATE_JSON.json);
});
$('#isolationLocationView').click(function () {
	changeListView(ISOLATION_LOCATION_JSON.json);
});

function showCommonNames(featureJsonList) {
	$('#pubStrainList').empty();
	var availableTags = [];
	for (i=0 ; i<featureJsonList.data.length ; i++) {
		var opt = document.createElement("option");
		var description = document.createTextNode(featureJsonList.data[i].uniquename);
		opt.value = featureJsonList.data[i].feature_id;
		opt.appendChild(description);
		document.getElementById('pubStrainList').appendChild(opt);

		availableTags.push( { label:featureJsonList.data[i].uniquename, value:featureJsonList.data[i].feature_id } );
	}
	$("#autoComp").autocomplete({
		source: availableTags,
		select: function( event, ui ) {
			$("#autoComp").val( ui.item.label );
			$("#autoComp_hidden").val( ui.item.value );
			return false;
		}
	});
}

function showAccessionNumbers(featureJsonList) {
	var availableTags = [];
	$('#pubStrainList').empty();
	for (i=0 ; i<featureJsonList.data.length ; i++) {
		var opt = document.createElement("option");
		var description = document.createTextNode(featureJsonList.data[i].dbxref.accession);
		opt.value = featureJsonList.data[i].feature_id;
		opt.appendChild(description);
		document.getElementById('pubStrainList').appendChild(opt);

		availableTags.push( { label:featureJsonList.data[i].dbxref.accession, value:featureJsonList.data[i].feature_id } );
	}
	$("#autoComp").autocomplete({
		source: availableTags,
		select: function( event, ui ) {
			$("#autoComp").val( ui.item.label );
			$("#autoComp_hidden").val( ui.item.value );
			return false;
		}
	});
}

function changeListView(jsonList) {
	$('#pubStrainInfoDropdown').hide();
	$('#pubStrainInfoSearch').hide();
	$('#strainInfoProgressbar').show()
	var availableTags = [];
	$('#pubStrainList').empty();
	
	for (i=0 ; i<jsonList.data.length ; i++) {
		var opt = document.createElement("option");
		var description = document.createTextNode(jsonList.data[i].value + ' - ' + jsonList.data[i].common_name);
		opt.value = jsonList.data[i].feature_id;
		opt.appendChild(description);
		document.getElementById('pubStrainList').appendChild(opt);

		availableTags.push( { label:jsonList.data[i].value + ' - ' + jsonList.data[i].common_name, value:jsonList.data[i].feature_id } );
	}
	
	$("#autoComp").autocomplete({
		source: availableTags,
		select: function( event, ui ) {
			$("#autoComp").val( ui.item.label );
			$("#autoComp_hidden").val( ui.item.value );
			return false;
		}
	});
	
	$('#pubStrainInfoDropdown').show();
	$('#pubStrainInfoSearch').show();
	$('#strainInfoProgressbar').hide()
}


</script>