<!DOCTYPE html>
<html>

<TMPL_INCLUDE NAME="header.tmpl">

<TMPL_INCLUDE NAME="nav_bar_strain_info.tmpl">

<body onload="onLoadCheck()" style="background-color:#796e6c">

	<div class="container" style="background-color:#FFFFFF">

		<div class="row-fluid" style="margin:10px 10px 10px 10px;padding:10px 10px 10px 10px">
			
			<h1><span>STRAIN</span> <span style="color:#d41616">INFORMATION</span></h1>
		</div>

		<div class="row-fluid">
			<TMPL_INCLUDE NAME="strain_info_form.tmpl">

			<TMPL_IF strainData>
			<div class="span8">
				<ul id="strainInfoTabs" class="nav nav-tabs" style="display:none">
					<li class="active"><a href="#overviewTab" data-toggle="tab">Overview</a></li>
					<li><a href="#phyloTreeTab" data-toggle="tab">Phylogenetic Tree</a></li>
					<li><a href="#virAmrTab" data-toggle="tab">Virulence and AMR</a></li>
					<TMPL_IF references>
					<li><a href="#refTab" data-toggle="tab">References</a></li>
					</TMPL_IF>
					<TMPL_IF comments>
					<li><a href="#commentTab" data-toggle="tab">Notes</a></li>
					</TMPL_IF>
				</ul>

				<div class="tab-content">
					<TMPL_INCLUDE NAME="strain_info_overview_tab.tmpl">

					<div class="tab-pane" id="phyloTreeTab">
						<div id="svgCanvas" style="padding:5px">
							<TMPL_INCLUDE NAME="phylogeny_strain_info.tmpl">
						</div>
					</div>

					<div class="tab-pane" id="virAmrTab">
						<div class="row-fluid" id="strainInfoDiv" style="margin:10px 10px 10px 0px">
							<div class="span6" style="height:300px;overflow:auto;margin-top:10px">
								<table class="table table-striped table-condensed">
									<thead></thead>
									<tr>
										<th>Virulence Factors</th>
									</tr>
									<TMPL_LOOP NAME=VIRDATA><tr><td><a href="#"><TMPL_VAR NAME=data></a></td></tr></TMPL_LOOP>
								</table>
							</div>
							<div class="span6" style="height:300px;overflow:auto;margin-top:10px">
								<table class="table table-striped table-condensed">
									<thead></thead>
									<tr>
										<th>AMR Genes</th>
									</tr>
									<TMPL_LOOP NAME=AMRDATA><tr><td><a href="#"><TMPL_VAR NAME=data></a></td></tr></TMPL_LOOP>
								</table>
							</div>
						</div>
					</div>

					<TMPL_IF references>
					<div class="tab-pane" id="refTab" style="margin:10px 10px 10px 0px">
						<TMPL_IF owners>
						<div class="row-fluid">
							<div class="span11">
								<span class="muted">Original submitter / Owner of genome: </span>
							</div>
							<div class="span11">
								<ol>
									<TMPL_LOOP owners>
									<li><TMPL_VAR owner></li>
									</TMPL_LOOP>
								</ol>
							</div>
						</div>
						<hr>
						</TMPL_IF>

						<TMPL_IF pmid_list>
						<div class="row-fluid">
							<div class="span11">
								<span class="muted">Pubmed References: </span>
							</div>
							
							<div id="pmid_results" class="span11">
							</div>
							<div id="pmid_error" style="display:none">
								Error occurred retrieving pubmed summaries.
							</div>
						</div>
						</TMPL_IF>
					</div>
					</TMPL_IF>

					<TMPL_IF comments>
					<div class="tab-pane" id="commentTab" style="margin:10px 10px 10px 0px">
						<div class="row-fluid">
							<ol>
								<TMPL_LOOP comments>
								<li><TMPL_VAR comment></li>
								</TMPL_LOOP>
							</ol>
						</div>
					</div>
					</TMPL_IF>
				</div>
			</div>
			</TMPL_IF>
			
		</div>
	</div>

</body>

<TMPL_INCLUDE NAME="footer.tmpl">

</html>

<script type="text/javascript">

var FEATURE_TABLE_JSON = <TMPL_VAR NAME=strainJSONData>;
/* 
Back lists that will get called to the client after page has loaded.
These remain as global constants.
*/
var ISOLATION_LOCATION_JSON = {};
var SEROTYPE_JSON = {};
var ISOLATION_HOST_JSON = {};
var ISOLATION_SOURCE_JSON = {};
var ISOLATION_DATE_JSON = {};

//pubmed IDs for Entrez search
var pmidList = "";
<TMPL_IF pmid_list>
pmidList = <TMPL_VAR pmid_list>;
</TMPL_IF>

//List of public feature ids used to get data for view switching

var featureIdList = "";
$(document).ready(function() {
	for (i=0 ; i<FEATURE_TABLE_JSON.data.length-1 ; i++) {
		featureIdList = featureIdList + String(FEATURE_TABLE_JSON.data[i].feature_id) + ",";
	}
	featureIdList = featureIdList + String(FEATURE_TABLE_JSON.data[FEATURE_TABLE_JSON.data.length-1].feature_id);
	
	if(pmidList != "") {
		entrezArgs = {'apikey' : '847d6279e0c5c435df1bd425c1628778',
		              'db'     : 'pubmed',
		              'id'     : pmidList
		             };
		             
		$.getJSON('http://entrezajax.appspot.com/esummary?callback=?', entrezArgs, function(data) {
			if(data.entrezajax.error) {
				$('#pmid_error').html('<p class="text-error">Error occurred retrieving pubmed summaries: '+data.entrezajax.error_message+'</p>');
			}
			$.each(data.result, function(i, item) {
				var author_list = '';
				for(var i = 0; i < item.AuthorList.length; i ++) {
					if(i != 0) {
						author_list += ', ';
					}
					author_list += item.AuthorList[i];
				}
				var html = '<p><a href=\'http://www.ncbi.nlm.nih.gov/pubmed/' + item.ArticleIds.pubmed + '\'>' + item.Title + '</a><br/>' + author_list + '<br/>' + item.FullJournalName + ' ' + item.PubDate + '</p>';
				$("<div/>").html(html).appendTo('#pmid_results');
			});
		});
	}
});

function onLoadCheck() {
	$('#strainInfoTabs').show("slow");
	initialize();
}

function initialize() {

	getPublicList("/serotype_form" , SEROTYPE_JSON, 'serotypeViewLabel', 'serotypeView', 'genodo_serotype');
	getPublicList("/host_source_form" , ISOLATION_HOST_JSON, 'isolationHostLabel', 'isolationHostView', 'genodo_isolation_host');
	getPublicList("/isolation_source_form" , ISOLATION_SOURCE_JSON, 'isolationSourceLabel', 'isolationSourceView', 'genodo_isolation_source');
	getPublicList("/isolation_date_form" , ISOLATION_DATE_JSON, 'isolationDateLabel', 'isolationDateView', 'genodo_isolation_date');
	getPublicList('/isolation_location_form' , ISOLATION_LOCATION_JSON, 'isolationLocationLabel', 'isolationLocationView', 'genodo_isolation_location');

}

function getPublicList(urlName,formType,labelId,radioId,typeName) {

	if(sessionStorage[typeName]  == null) {
		// Get list from server and save in local storage
		$.ajax({
			type: "POST",
			url: urlName,
			data: { public_id_list: featureIdList }
		}).done(function (returned_data) {
			sessionStorage[typeName] = returned_data;
			formType.json = $.parseJSON(returned_data);
			$('#'+radioId).attr('disabled',false);
			$('#'+labelId+'Loading').hide();
			$('#'+labelId).show();
		});
	} else {
		formType.json = $.parseJSON(sessionStorage[typeName]);
		$('#'+radioId).attr('disabled',false);
		$('#'+labelId+'Loading').hide();
		$('#'+labelId).show();
	}
}

/*
The next functions are for switching form views:
*/

$('#commonNameView').click(function () {
	showCommonNames(FEATURE_TABLE_JSON);
});
$('#accessionNumberView').click(function () {
	showAccessionNumbers(FEATURE_TABLE_JSON);
});
$('#isolationHostView').click(function () {
	changeListView(ISOLATION_HOST_JSON.json);
});
$('#isolationSourceView').click(function () {
	changeListView(ISOLATION_SOURCE_JSON.json);
});
$('#serotypeView').click(function () {
	changeListView(SEROTYPE_JSON.json);
});
$('#isolationDateView').click(function () {
	changeListView(ISOLATION_DATE_JSON.json);
});
$('#isolationLocationView').click(function () {
	changeListView(ISOLATION_LOCATION_JSON.json);
});

function showCommonNames(featureJsonList) {
	$('#pubStrainList').empty();
	var availableTags = [];
	for (i=0 ; i<featureJsonList.data.length ; i++) {
		var opt = document.createElement("option");
		var description = document.createTextNode(featureJsonList.data[i].uniquename);
		opt.value = featureJsonList.data[i].feature_id;
		opt.appendChild(description);
		document.getElementById('pubStrainList').appendChild(opt);

		availableTags.push( { label:featureJsonList.data[i].uniquename, value:featureJsonList.data[i].feature_id } );
	}
	$("#autoComp").autocomplete({
		source: availableTags,
		select: function( event, ui ) {
			$("#autoComp").val( ui.item.label );
			$("#autoComp_hidden").val( ui.item.value );
			return false;
		}
	});
}

function showAccessionNumbers(featureJsonList) {
	var availableTags = [];
	$('#pubStrainList').empty();
	for (i=0 ; i<featureJsonList.data.length ; i++) {
		var opt = document.createElement("option");
		var description = document.createTextNode(featureJsonList.data[i].dbxref.accession);
		opt.value = featureJsonList.data[i].feature_id;
		opt.appendChild(description);
		document.getElementById('pubStrainList').appendChild(opt);

		availableTags.push( { label:featureJsonList.data[i].dbxref.accession, value:featureJsonList.data[i].feature_id } );
	}
	$("#autoComp").autocomplete({
		source: availableTags,
		select: function( event, ui ) {
			$("#autoComp").val( ui.item.label );
			$("#autoComp_hidden").val( ui.item.value );
			return false;
		}
	});
}

function changeListView(jsonList) {
	$('#pubStrainInfoDropdown').hide();
	$('#pubStrainInfoSearch').hide();
	$('#strainInfoProgressbar').show()
	var availableTags = [];
	$('#pubStrainList').empty();
	
	for (i=0 ; i<jsonList.data.length ; i++) {
		var opt = document.createElement("option");
		var description = document.createTextNode(jsonList.data[i].value + ' - ' + jsonList.data[i].common_name);
		opt.value = jsonList.data[i].feature_id;
		opt.appendChild(description);
		document.getElementById('pubStrainList').appendChild(opt);

		availableTags.push( { label:jsonList.data[i].value + ' - ' + jsonList.data[i].common_name, value:jsonList.data[i].feature_id } );
	}
	
	$("#autoComp").autocomplete({
		source: availableTags,
		select: function( event, ui ) {
			$("#autoComp").val( ui.item.label );
			$("#autoComp_hidden").val( ui.item.value );
			return false;
		}
	});
	
	$('#pubStrainInfoDropdown').show();
	$('#pubStrainInfoSearch').show();
	$('#strainInfoProgressbar').hide()
}


</script>