<!DOCTYPE html>
<html>



<head>
	<link rel="stylesheet" href="/App/Styling/css/genodo_tree.css">
	<link rel="stylesheet" href="/App/Styling/css/jquery-ui-1.10.3.custom.css">
	<script src="/App/Styling/js/jquery-1.9.1.js"></script>
	<script src="/App/Styling/js/jquery-ui-1.10.3.custom.js"></script>
	<script src="/App/Styling/js/d3.v3/d3.v3.min.js"></script>
	<link media="screen" href="/App/Styling/css/bootstrap.css" type="text/css" rel="stylesheet">
	<link media="screen" href="/App/Styling/css/bootstrap-responsive.css" type="text/css" rel="stylesheet">
	
	<TMPL_INCLUDE NAME="phylogeny_single_strain_header.tmpl">

</head>

<TMPL_INCLUDE NAME="nav_bar_strain_info.tmpl">

<body onload="onLoadCheck()" style="background-color:#796e6c">

	<div class="container" style="background-color:#FFFFFF">

		<div class="row-fluid" style="margin:10px 10px 10px 10px;padding:10px 10px 10px 10px">
			
			<h1><span>STRAIN</span> <span style="color:#d41616">INFORMATION</span></h1>
		</div>

		<div class="row-fluid">
			<TMPL_INCLUDE NAME="strain_info_form.tmpl">

			<TMPL_IF strainData>
			<div class="span7">
				<ul id="strainInfoTabs" class="nav nav-tabs" style="display:none">
					<li class="active"><a href="#overviewTab" data-toggle="tab">Overview</a></li>
					<li><a href="#phyloTreeTab" data-toggle="tab">Phylogenetic Tree</a></li>
					<li><a href="#virAmrTab" data-toggle="tab">Virulence and AMR</a></li>
					<TMPL_IF NAME=LOCATION>
					<li><a href="#mapTab" data-toggle="tab">Map</a></li>
					</TMPL_IF>
					<TMPL_IF references>
					<li><a href="#refTab" data-toggle="tab">References</a></li>
					</TMPL_IF>
					<TMPL_IF comments>
					<li><a href="#commentTab" data-toggle="tab">Notes</a></li>
					</TMPL_IF>
				</ul>

				<div class="tab-content">
					<TMPL_INCLUDE NAME="strain_info_overview_tab.tmpl">

					<div class="tab-pane" id="phyloTreeTab">
						<script>
							var smallTreeWindow = true;
							var centreOnSelectedNode = true;
						</script>
						<TMPL_INCLUDE NAME="phylogeny_single_strain.tmpl">
					</div>

					<div class="tab-pane" id="mapTab">
						<div id="map-canvas" style="height:300px;padding:10px"></div>
					</div>

					<div class="tab-pane" id="virAmrTab">
						<div class="row-fluid" id="strainInfoDiv" style="margin:10px 10px 10px 0px">
							<div class="span6" style="height:300px;overflow:auto;margin-top:10px">
								<table class="table table-striped table-condensed">
									<thead></thead>
									<tr>
										<th>Virulence Factors</th>
									</tr>
									<TMPL_LOOP NAME=VIRDATA><tr><td><button id="vir_amr_link" class="btn btn-small btn-link" value="<TMPL_VAR NAME=feature_id>" onclick="showVFMetaInfo(this)" style="color:#796e6c"><TMPL_VAR NAME=gene_name></a></td></tr></TMPL_LOOP>
								</table>
							</div>
							<div class="span6" style="height:300px;overflow:auto;margin-top:10px">
								<table class="table table-striped table-condensed">
									<thead></thead>
									<tr>
										<th>AMR Genes</th>
									</tr>
									<TMPL_LOOP NAME=AMRDATA><tr><td><button id="vir_amr_link" class="btn btn-small btn-link" value="<TMPL_VAR NAME=feature_id>" onclick="showAMRMetaInfo(this)" style="color:#796e6c"><TMPL_VAR NAME=gene_name></a></td></tr></TMPL_LOOP>
								</table>
							</div>
						</div>

						<div class="row-fluid">
							<div id="VFMetaInfo" class="span6" style="border-style:solid;border-width:1px;border-color:#d3d3d3;margin:10px 5px 10px 0px;padding:10px;max-height:300px;overflow:auto">Click on any of the virulence factors above to see more info.</div>
							<div id="AMRMetaInfo" class="span6" style="border-style:solid;border-width:1px;border-color:#d3d3d3;margin:10px 0px 10px 5px;padding:10px;max-height:300px;overflow:auto">Click on any of the amr genes above to see more info</div>
						</div>

					</div>

					<TMPL_IF references>
					<div class="tab-pane" id="refTab" style="margin:10px 10px 10px 0px">
						<TMPL_IF owners>
						<div class="row-fluid">
							<div class="span11">
								<span class="muted">Original submitter / Owner of genome: </span>
							</div>
							<div class="span11">
								<ol>
									<TMPL_LOOP owners>
									<li><TMPL_VAR owner></li>
									</TMPL_LOOP>
								</ol>
							</div>
						</div>
						<hr>
						</TMPL_IF>

						<TMPL_IF pmid_list>
						<div class="row-fluid">
							<div class="span11">
								<span class="muted">Pubmed References: </span>
							</div>
							
							<div id="pmid_results" class="span11">
							</div>
							<div id="pmid_error" style="display:none">
								Error occurred retrieving pubmed summaries.
							</div>
						</div>
						</TMPL_IF>
					</div>
					</TMPL_IF>

					<TMPL_IF comments>
					<div class="tab-pane" id="commentTab" style="margin:10px 10px 10px 0px">
						<div class="row-fluid">
							<ol>
								<TMPL_LOOP comments>
								<li><TMPL_VAR comment></li>
								</TMPL_LOOP>
							</ol>
						</div>
					</div>
					</TMPL_IF>
				</div>
			</div>
			</TMPL_IF>

			<div class="tab-pane" id="strainInfoMapTab">
			</div>
			
		</div>
	</div>

</body>

<TMPL_INCLUDE NAME="footer.tmpl">

</html>

<script type="text/javascript">

function showVFMetaInfo(tag) {
	$('#VFMetaInfo').empty();
	$('#VFMetaInfo').append('<div class="span5" id="wheel-loader" style="margin:10px 0px 0px 0px"><small><em><img src="/App/Pictures/wheel-loader.gif"> Loading Info...</em></small></div>');

	$.post("/vf_meta_info", { VFName: tag.getAttribute("value")},  
		function(vir){
			$('#VFMetaInfo').empty();
			$('#VFMetaInfo').append('<div class="span7"><h4>'+vir.data[0].gene_name+' ('+vir.data[0].uniquename+') '+'</h4></div>');

			for (var i = 1; i < vir.data.length; i++) {
				$('#VFMetaInfo').append('<div class="span12" style="margin:20px 0px 5px 20px"><span class="text-info" id="vfTerms"><strong>' + vir.data[i].term_name + '</strong></span></div><div class="span12"><ol><li style="padding-left:10px">' + vir.data[i].value + '</li></ol></div>');
			}

		}, "json" , $('#VFMetaInfo').show());
}

function showAMRMetaInfo(tag) {
	$('#AMRMetaInfo').empty();
	$('#AMRMetaInfo').append('<div class="span5" id="wheel-loader" style="margin:10px 0px 0px 0px"><small><em><img src="/App/Pictures/wheel-loader.gif"> Loading Info...</em></small></div>');
	$.post("/amr_meta_info",  { AMRName: tag.getAttribute("value")},  
		function(amr){
			$('#AMRMetaInfo').empty();
			
			var amrhtml = '<div class="span9"><h4>'+amr.data.name+'</h4></div>';
			
			if(amr.data.synonyms.length > 0) {
				amrhtml += 
				'<div class="span3"><span class="muted" style="padding-left:20px;">Synonyms: </span></div>';
				amrhtml += '<div class="span9">';
				for(var i = 0; i < amr.data.synonyms.length; i++) {
					amrhtml += '<span style="padding-left:10px">'+amr.data.synonyms[i]+'</span>';
				}
				amrhtml += '</div>';
			}
			
			$('#AMRMetaInfo').append(amrhtml);
			
			if(amr.data.descriptions.length > 0) {

				var defhtml =
				'<div class="span12" style="margin:20px 0px 5px 20px"><span class="text-info"><strong>Description</strong></span></div>'+
				'<div class="span12"><ol>';
				
				for(var j = 0; j < amr.data.descriptions.length; j++) {
					defhtml += '<li style="padding-left:10px">'+amr.data.descriptions[j]+'</li>'
				}
				
				defhtml += '</ol></div>';
				$('#AMRMetaInfo').append(defhtml);
			}
			
			if(amr.data.aro_terms.length > 0) {

				var arohtml =
				'<div class="span12" style="margin:20px 0px 5px 20px"><span class="text-info"><strong>Antimicrobial Resistance Ontology Annotations</strong></span></div>'+
				'<div class="span12"><ol>';
				
				for(var j = 0; j < amr.data.aro_terms.length; j++) {
					arohtml += '<li style="padding-left:10px"><strong>'+amr.data.aro_terms[j].accession+' '+amr.data.aro_terms[j].term_name+
					'</strong><br>'+amr.data.aro_terms[j].term_defn+'</li>'
				}
				
				arohtml += '</ol></div>';
				$('#AMRMetaInfo').append(arohtml);
			}
			
			//$('#AMRMetaInfo').append('</div>');

		}, "json" , $('#AMRMetaInfo').show());
}


//pubmed IDs for Entrez search
var pmidList = "";
<TMPL_IF pmid_list>
pmidList = <TMPL_VAR pmid_list>;
</TMPL_IF>

$(document).ready(function() {
	
	if(pmidList != "") {
		var entrezArgs = {
			'apikey' : '847d6279e0c5c435df1bd425c1628778',
			'db'     : 'pubmed',
			'id'     : pmidList
		};

		$.getJSON('http://entrezajax.appspot.com/esummary?callback=?', entrezArgs, function(data) {
			if(data.entrezajax.error) {
				$('#pmid_error').html('<p class="text-error">Error occurred retrieving pubmed summaries: '+data.entrezajax.error_message+'</p>');
			}
			$.each(data.result, function(i, item) {
				var author_list = '';
				for(var i = 0; i < item.AuthorList.length; i ++) {
					if(i != 0) {
						author_list += ', ';
					}
					author_list += item.AuthorList[i];
				}
				var html = '<p><a href=\'http://www.ncbi.nlm.nih.gov/pubmed/' + item.ArticleIds.pubmed + '\'>' + item.Title + '</a><br/>' + author_list + '<br/>' + item.FullJournalName + ' ' + item.PubDate + '</p>';
				$("<div/>").html(html).appendTo('#pmid_results');
			});
		});
	}
});

function onLoadCheck() {
	//initializeMap();
	$('#strainInfoTabs').show("slow");
}

var map;

function initializeMap() {
	codeAddress();
}

function codeAddress() {
	var address = '<TMPL_VAR NAME=strainLocation>';

	//Parses the location name for the marker title
	var locationName = address.match(/<location>[\w\d\W\D]*<\/location>/)[0];
	locationName = locationName.replace(/<location>/, '');
	locationName = locationName.replace(/<\/location>/, '');
	locationName = locationName.replace(/<[\/]+[\w\d]*>/g, '');
	locationName = locationName.replace(/<[\w\d]*>/g, ', ');
	locationName = locationName.replace(/, /, '');

	var locationCoordinates = address.match(/<coordinates>[\w\d\W\D]*<\/coordinates>/)[0];

	//Parses out the center LatLong point
	var locationCenter = locationCoordinates.match(/<center>[\w\d\W\D]*<\/center>/)[0];
	var locationCenterLat = locationCenter.match(/<lat>[\w\d\W\D]*<\/lat>/)[0];
	locationCenterLat = locationCenterLat.replace(/<lat>/, '');
	locationCenterLat = locationCenterLat.replace(/<\/lat>/, '');
	var locationCenterLng = locationCenter.match(/<lng>[\w\d\W\D]*<\/lng>/)[0];
	locationCenterLng = locationCenterLng.replace(/<lng>/, '');
	locationCenterLng = locationCenterLng.replace(/<\/lng>/, '');

	//Parses out boundary LatLongs
	var locationViewportSW = locationCoordinates.match(/<southwest>[\w\d\W\D]*<\/southwest>/)[0];
	var locationViewportSWLat = locationViewportSW.match(/<lat>[\w\d\W\D]*<\/lat>/)[0];
	var locationViewportSWLng = locationViewportSW.match(/<lng>[\w\d\W\D]*<\/lng>/)[0];
	locationViewportSWLat = locationViewportSWLat.replace(/<lat>/, '');
	locationViewportSWLat = locationViewportSWLat.replace(/<\/lat>/, '');
	locationViewportSWLng = locationViewportSWLng.replace(/<lng>/, '');
	locationViewportSWLng = locationViewportSWLng.replace(/<\/lng>/, '');

	var locationViewportNE = locationCoordinates.match(/<northeast>[\w\d\W\D]*<\/northeast>/)[0];
	var locationViewportNELat = locationViewportNE.match(/<lat>[\w\d\W\D]*<\/lat>/)[0];
	var locationViewportNELng = locationViewportNE.match(/<lng>[\w\d\W\D]*<\/lng>/)[0];
	locationViewportNELat = locationViewportNELat.replace(/<lat>/, '');
	locationViewportNELat = locationViewportNELat.replace(/<\/lat>/, '');
	locationViewportNELng = locationViewportNELng.replace(/<lng>/, '');
	locationViewportNELng = locationViewportNELng.replace(/<\/lng>/, '');

	var centerLatLng = new google.maps.LatLng(locationCenterLat, locationCenterLng);
	var swLatLng = new google.maps.LatLng(locationViewportSWLat, locationViewportSWLng);
	var neLatLng = new google.maps.LatLng(locationViewportNELat, locationViewportNELng);
	var markerBounds = new google.maps.LatLngBounds(swLatLng, neLatLng);

	var mapOptions = {
		zoom: 3,
		zoomControl: true,
		streetViewControl: false,
		center: centerLatLng,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	map = new google.maps.Map(document.getElementById('map-canvas'),
		mapOptions);

	map.fitBounds(markerBounds);

	var marker = new google.maps.Marker({
		map: map,
		position: centerLatLng,
		animation: google.maps.Animation.DROP,
		title: locationName
	});
}

$('a[href="#mapTab"]').click( function(){
	setTimeout("initializeMap()", 0);
	//initializeMap(); 
});


//google.maps.event.addDomListener(window, 'load', initializeMap);


</script>