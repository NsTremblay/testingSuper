<!DOCTYPE html>
<html>

<head>

	<TMPL_INCLUDE NAME="header.tmpl">

	<!-- SuperPhyloTree -->
	<link rel="stylesheet" href="/App/Styling/css/genodo_tree.css">
	<link rel="stylesheet" href="/App/Styling/css/jquery-ui-1.10.3.custom.css">
	<script src="/App/Styling/js/jquery-1.9.1.js"></script>
	<script src="/App/Styling/js/jquery-ui-1.10.3.custom.js"></script>
	<script src="/App/Styling/js/genodo_tree_functions.js"></script>
	<!-- D3.js -->
	<script src="/App/Styling/js/d3.v3/d3.v3.min.js"></script>
	<!-- Google Maps -->
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDfsRetldM0eW0vVemFKt48xYaZwKQACY&sensor=true"></script>
	<script type="text/javascript" src="/App/Styling/js/genodo_map_functions.js"></script>
	<script type="text/javascript" src="/App/Styling/js/markerclusterer.js"></script>
	<!-- MetaTab -->
	<script type="text/javascript" src="/App/Styling/js/genodo_meta_tab.js"></script>

</head>

<body onload="onLoadCheck()" style="background-color:#796e6c">

	<TMPL_INCLUDE NAME="phylogeny_single_strain_header.tmpl">

	<TMPL_INCLUDE NAME="nav_bar.tmpl">

	<div class="container" style="background-color:#FFFFFF">

		<div class="row-fluid" style="margin:10px 10px 10px 10px;padding:10px 10px 10px 10px">
			
			<h1><span>STRAIN</span> <span style="color:#d41616">INFORMATION</span></h1>
		</div>

		<div class="row-fluid">
			<TMPL_INCLUDE NAME="strain_info_form.tmpl">

			<TMPL_IF strainData>
			<div class="span7">
				<ul id="strainInfoTabs" class="nav nav-tabs" style="display:none">
					<li class="active"><a href="#overviewTab" data-toggle="tab">Overview</a></li>
					<li><a href="#phyloTreeTab" data-toggle="tab">Phylogenetic Tree</a></li>
					<li><a href="#virAmrTab" data-toggle="tab">Virulence and AMR</a></li>
					<TMPL_IF NAME=LOCATION>
					<li><a href="#mapTab" data-toggle="tab">Map</a></li>
					</TMPL_IF>
					<TMPL_IF references>
					<li><a href="#refTab" data-toggle="tab">References</a></li>
					</TMPL_IF>
					<TMPL_IF comments>
					<li><a href="#commentTab" data-toggle="tab">Notes</a></li>
					</TMPL_IF>
				</ul>

				<div class="tab-content">
					<TMPL_INCLUDE NAME="strain_info_overview_tab.tmpl">

					<div class="tab-pane" id="phyloTreeTab">
						<script>
						var smallTreeWindow = true;
						var centreOnSelectedNode = true;
						</script>
						<TMPL_INCLUDE NAME="phylogeny_single_strain.tmpl">
					</div>

					<div class="tab-pane" id="mapTab">
						<div id="map-canvas" style="height:300px;padding:10px"></div>
						<div style="height:200px;margin-top:10px;margin-bottom:10px;overflow:auto;border:solid;border-width:1px;border-color:#d3d3d3">
							<ul id="visibleMarkers" style="list-style:none"></ul>
						</div>
					</div>

					<div class="tab-pane" id="virAmrTab">
						<div class="row-fluid" id="strainInfoDiv" style="margin:10px 10px 10px 0px">

							<span class="help-block">Click on any of the genes below to view detailed page of information for that gene.</span>

							<div class="span5" style="height:300px;overflow:auto;margin-top:10px">
								<table class="table table-striped table-condensed">
									<thead></thead>
									<tr>
										<th>Virulence Factors</th>
									</tr>
									<TMPL_LOOP NAME=VIRDATA>
									<tr>
										<td>
											<TMPL_VAR NAME=gene_name> <a href="/virulence-factors/view?vf=<TMPL_VAR NAME=feature_id>"><i class="icon-search"></i> info</a>
										</td>
									</tr>
									</TMPL_LOOP>
								</table>
							</div>
							<div class="span5" style="height:300px;overflow:auto;margin-top:10px">
								<table class="table table-striped table-condensed">
									<thead></thead>
									<tr>
										<th>AMR Genes</th>
									</tr>
									<TMPL_LOOP NAME=AMRDATA>
									<tr>
										<td>
											<TMPL_VAR NAME=gene_name> <a href="/virulence-factors/view?amr=<TMPL_VAR NAME=feature_id>"><i class="icon-search"></i> info</a>
										</td>
									</tr>
									</TMPL_LOOP>
								</table>
							</div>
						</div>

					</div>

					<TMPL_IF references>
					<div class="tab-pane" id="refTab" style="margin:10px 10px 10px 0px">
						<TMPL_IF owners>
						<div class="row-fluid">
							<div class="span11">
								<span class="muted">Original submitter / Owner of genome: </span>
							</div>
							<div class="span11">
								<ol>
									<TMPL_LOOP owners>
									<li><TMPL_VAR owner></li>
									</TMPL_LOOP>
								</ol>
							</div>
						</div>
						<hr>
						</TMPL_IF>

						<TMPL_IF pmid_list>
						<div class="row-fluid">
							<div class="span11">
								<span class="muted">Pubmed References: </span>
							</div>

							<div id="pmid_results" class="span11">
							</div>
							<div id="pmid_error" style="display:none">
								Error occurred retrieving pubmed summaries.
							</div>
						</div>
						</TMPL_IF>
					</div>
					</TMPL_IF>

					<TMPL_IF comments>
					<div class="tab-pane" id="commentTab" style="margin:10px 10px 10px 0px">
						<div class="row-fluid">
							<ol>
								<TMPL_LOOP comments>
								<li><TMPL_VAR comment></li>
								</TMPL_LOOP>
							</ol>
						</div>
					</div>
					</TMPL_IF>
				</div>
			</div>
			</TMPL_IF>
		</div>
	</div>

</body>

<TMPL_INCLUDE NAME="footer.tmpl">

</html>

<script type="text/javascript">

//pubmed IDs for Entrez search
var pmidList = "";
<TMPL_IF pmid_list>
pmidList = <TMPL_VAR pmid_list>;
</TMPL_IF>

$(document).ready(function() {
	
	if(pmidList != "") {
		var entrezArgs = {
			'apikey' : '847d6279e0c5c435df1bd425c1628778',
			'db'     : 'pubmed',
			'id'     : pmidList
		};

		$.getJSON('http://entrezajax.appspot.com/esummary?callback=?', entrezArgs, function(data) {
			if(data.entrezajax.error) {
				$('#pmid_error').html('<p class="text-error">Error occurred retrieving pubmed summaries: '+data.entrezajax.error_message+'</p>');
			}
			$.each(data.result, function(i, item) {
				var author_list = '';
				for(var i = 0; i < item.AuthorList.length; i ++) {
					if(i != 0) {
						author_list += ', ';
					}
					author_list += item.AuthorList[i];
				}
				var html = '<p><a href=\'http://www.ncbi.nlm.nih.gov/pubmed/' + item.ArticleIds.pubmed + '\'>' + item.Title + '</a><br/>' + author_list + '<br/>' + item.FullJournalName + ' ' + item.PubDate + '</p>';
				$("<div/>").html(html).appendTo('#pmid_results');
			});
		});
	}
});

function onLoadCheck() {
	$('#strainInfoTabs').show("slow");
}

$('a[href="#mapTab"]').click( function(){
	setTimeout("showMap()", 0);
});

var public_genomes = <TMPL_VAR public_genomes>;
var public_location_genomes = {};
var private_genomes = <TMPL_VAR private_genomes>;
var private_location_genomes = {};

function showMap() {
	var mapOptions = {
		center: new google.maps.LatLng(-0.000, 0.000),
		zoom: 1,
		streetViewControl: false,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};

	var mapFactory = new Map(mapOptions, "map-canvas");
	var map = mapFactory.initializeMap();

	var selectedLocation = mapFactory.parseLocation(public_genomes["<TMPL_IF LOCATION><TMPL_VAR strainLocation></TMPL_IF>"]);

	var lists = mapFactory.addMultiMarkers(public_genomes, public_location_genomes, map, "<TMPL_IF LOCATION><TMPL_VAR strainLocation></TMPL_IF>");
	var multiMarkers = lists[0];
	var clusterList = lists[1];

	var visableMarkers = multiMarkers;

	var mcOptions = {gridSize: 50, maxZoom: 15};
	var mc = new MarkerClusterer(map, clusterList, mcOptions);

	var selectedMarkerOverlay = mapFactory.showSelectedGenome(selectedLocation, map);
	(selectedLocation) ? map.fitBounds(selectedLocation.markerBounds) : 0;

	google.maps.event.addListener(map, 'bounds_changed', function() {
		visableMarkers = mapFactory.updateVisibleMarkers(visableMarkers, multiMarkers, map, "visibleMarkers");
	});
}

</script>