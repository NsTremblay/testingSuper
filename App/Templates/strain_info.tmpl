<!DOCTYPE html>
<html>

<TMPL_INCLUDE NAME="header.tmpl">

<TMPL_INCLUDE NAME="nav_bar_viewing_options.tmpl">

<body onload="onLoadCheck()" style="background-color:#796e6c">

	<div class="container" style="background-color:#FFFFFF">

		<div style="margin:10px 10px 10px 10px;padding:10px 10px 10px 10px">
			<h1>Strain Information</h1>
		</div>

		<div class="row-fluid">
			<TMPL_INCLUDE NAME="strain_info_form_with_map.tmpl">

			<TMPL_IF strainData>
			<div class="span8">

				<ul id="strainInfoTabs" class="nav nav-tabs" style="display:none">
					<li class="active"><a href="#overviewTab" data-toggle="tab">Overview</a></li>
					<li><a href="#phyloTreeTab" data-toggle="tab">Phylogenetic Tree</a></li>
					<!--li><a href="#mapTab" data-toggle="tab">Map</a></li-->
					<li><a href="#virAmrTab" data-toggle="tab">Virulence and AMR</a></li>
					<TMPL_IF references>
					<li><a href="#refTab" data-toggle="tab">References</a></li>
					</TMPL_IF>
					<TMPL_IF comments>
					<li><a href="#commentTab" data-toggle="tab">Notes</a></li>
					</TMPL_IF>
				</ul>

				<div class="tab-content">

					<TMPL_INCLUDE NAME="strain_info_overview_tab.tmpl">

					<div class="tab-pane" id="phyloTreeTab">
						<div id="svgCanvas" style="padding:5px">
							<TMPL_INCLUDE NAME="phylogeny_strain_info.tmpl">
						</div>
					</div>

					<!--div class="tab-pane" id="mapTab">
						<div id="map_div" style="display:none;border-style:solid;border-width:1px;border-color:#d3d3d3;margin:0px 10px 10px 0px;padding:10px">
							<div id="map_canvas" style="height:300px"></div>
						</div>
					</div-->

					<div class="tab-pane" id="virAmrTab">
						<div class="row-fluid" id="strainInfoDiv" style="margin:10px 10px 10px 0px">

							<div class="span6" style="height:300px;overflow:auto;margin-top:10px">
								<table class="table table-striped table-condensed">
									<thead></thead>
									<tr>
										<th>Virulence Factors</th>
									</tr>
									<TMPL_LOOP NAME=VIRDATA><tr><td><TMPL_VAR NAME=data></td></tr></TMPL_LOOP>
								</table>
							</div>

							<div class="span6" style="height:300px;overflow:auto;margin-top:10px">
								<table class="table table-striped table-condensed">
									<thead></thead>
									<tr>
										<th>AMR Genes</th>
									</tr>
									<TMPL_LOOP NAME=AMRDATA><tr><td><TMPL_VAR NAME=data></td></tr></TMPL_LOOP>
								</table>
							</div>
						</div>
					</div>
					
					<TMPL_IF references>
					<div class="tab-pane" id="refTab" style="margin:10px 10px 10px 0px">
						<TMPL_IF owners>
						<div class="row-fluid">
							<div class="span11">
								<span class="muted">Original submitter / Owner of genome: </span>
							</div>
							<div class="span11">
								<ol>
									<TMPL_LOOP owners>
									<li><TMPL_VAR owner></li>
									</TMPL_LOOP>
								</ol>
							</div>
						</div>
						<hr>
						</TMPL_IF>
						
						<TMPL_IF pmids>
						<div class="row-fluid">
							<div class="span11">
								<span class="muted">Pubmed References: </span>
							</div>
							<div class="span11">
								<ol>
									<TMPL_LOOP pmids>
									<li><TMPL_VAR pmid></li>
									</TMPL_LOOP>
								</ol>
							</div>
						</div>
						</TMPL_IF>
					</div>
					</TMPL_IF>
					
					<TMPL_IF comments>
					<div class="tab-pane" id="commentTab" style="margin:10px 10px 10px 0px">
						<div class="row-fluid">
							<ol>
								<TMPL_LOOP comments>
								<li><TMPL_VAR comment><span>
									</TMPL_LOOP>
								</ol>
							</div>
						</div>
						</TMPL_IF>
						
					</div>

				</div>
				</TMPL_IF>

			</div>

			<script>
			var featureTableJson = <TMPL_VAR NAME=strainJSONData>;

			$('#commonNameView').click(function () {
				$('#pubStrainList').empty();
				var availableTags = [];
				for (i=0 ; i<featureTableJson.data.length ; i++) {
					var opt = document.createElement("option");
					var description = document.createTextNode(featureTableJson.data[i].uniquename);
					opt.value = featureTableJson.data[i].feature_id;
					opt.appendChild(description);
					document.getElementById('pubStrainList').appendChild(opt);

					availableTags.push( { label:featureTableJson.data[i].uniquename, value:featureTableJson.data[i].feature_id } );
				}
				$("#autoComp").autocomplete({
					source: availableTags,
					select: function( event, ui ) {
						$("#autoComp").val( ui.item.label );
						$("#autoComp_hidden").val( ui.item.value );
						return false;
					}
				});
			});

			$('#accessionNumberView').click(function () {
				var availableTags = [];
				$('#pubStrainList').empty();
				for (i=0 ; i<featureTableJson.data.length ; i++) {
					var opt = document.createElement("option");
					var description = document.createTextNode(featureTableJson.data[i].dbxref.accession);
					opt.value = featureTableJson.data[i].feature_id;
					opt.appendChild(description);
					document.getElementById('pubStrainList').appendChild(opt);

					availableTags.push( { label:featureTableJson.data[i].dbxref.accession, value:featureTableJson.data[i].feature_id } );
				}
				$("#autoComp").autocomplete({
					source: availableTags,
					select: function( event, ui ) {
						$("#autoComp").val( ui.item.label );
						$("#autoComp_hidden").val( ui.item.value );
						return false;
					}
				});
			});

/*
The remainder of the data switches will require ajax calls to the server to update forms
*/

$(document).ready( function(){
	var featureIdList = "";
	for (i=0 ; i<featureTableJson.data.length-1 ; i++) {
		featureIdList = featureIdList + String(featureTableJson.data[i].feature_id) + ",";
	}

	featureIdList = featureIdList + String(featureTableJson.data[featureTableJson.data.length-1].feature_id);

	console.log(featureIdList);

	$('#isolationHostView').click( function() {
		$('#pubStrainInfoDropdown').hide();
		$('#pubStrainInfoSearch').hide();
		$('#strainInfoProgressbar').show()
		$.ajax({
			type: "POST",
			url: "/host_source_form",
			data: { public_id_list: featureIdList }
		}).done(function (returned_data) {
			var hostSourceTableJsonString = returned_data;
			var hostSourceTableJson = $.parseJSON(hostSourceTableJsonString);
			console.log(hostSourceTableJson);
			var availableTags = [];
			$('#pubStrainList').empty();
			for (i=0 ; i<hostSourceTableJson.data.length ; i++) {
				var opt = document.createElement("option");
				var description = document.createTextNode(hostSourceTableJson.data[i].value);
				opt.value = hostSourceTableJson.data[i].feature_id;
				opt.appendChild(description);
				document.getElementById('pubStrainList').appendChild(opt);

				availableTags.push( { label:hostSourceTableJson.data[i].value, value:hostSourceTableJson.data[i].feature_id } );
			}
			$("#autoComp").autocomplete({
				source: availableTags,
				select: function( event, ui ) {
					$("#autoComp").val( ui.item.label );
					$("#autoComp_hidden").val( ui.item.value );
					return false;
				}
			});
			$('#pubStrainInfoDropdown').show();
			$('#pubStrainInfoSearch').show();
			$('#strainInfoProgressbar').hide()
		});
});


$('#isolationSourceView').click( function() {
	$('#pubStrainInfoDropdown').hide();
	$('#pubStrainInfoSearch').hide();
	$('#strainInfoProgressbar').show()
	$.ajax({
		type: "POST",
		url: "/isolation_source_form",
		data: { public_id_list: featureIdList }
	}).done(function (returned_data) {
		var hostSourceTableJsonString = returned_data;
		var hostSourceTableJson = $.parseJSON(hostSourceTableJsonString);
		console.log(hostSourceTableJson);
		var availableTags = [];
		$('#pubStrainList').empty();

		for (i=0 ; i<hostSourceTableJson.data.length ; i++) {
			var opt = document.createElement("option");
			var description = document.createTextNode(hostSourceTableJson.data[i].value);
			opt.value = hostSourceTableJson.data[i].feature_id;
			opt.appendChild(description);
			document.getElementById('pubStrainList').appendChild(opt);

			availableTags.push( { label:hostSourceTableJson.data[i].value, value:hostSourceTableJson.data[i].feature_id } );
		}
		$("#autoComp").autocomplete({
			source: availableTags,
			select: function( event, ui ) {
				$("#autoComp").val( ui.item.label );
				$("#autoComp_hidden").val( ui.item.value );
				return false;
			}
		});
		$('#pubStrainInfoDropdown').show();
		$('#pubStrainInfoSearch').show();
		$('#strainInfoProgressbar').hide()
	});
});

$('#serotypeView').click( function() {
	$('#pubStrainInfoDropdown').hide();
	$('#pubStrainInfoSearch').hide();
	$('#strainInfoProgressbar').show()
	$.ajax({
		type: "POST",
		url: "/serotype_form",
		data: { public_id_list: featureIdList }
	}).done(function (returned_data) {
		var hostSourceTableJsonString = returned_data;
		var hostSourceTableJson = $.parseJSON(hostSourceTableJsonString);
		console.log(hostSourceTableJson);
		var availableTags = [];
		$('#pubStrainList').empty();

		for (i=0 ; i<hostSourceTableJson.data.length ; i++) {
			var opt = document.createElement("option");
			var description = document.createTextNode(hostSourceTableJson.data[i].value);
			opt.value = hostSourceTableJson.data[i].feature_id;
			opt.appendChild(description);
			document.getElementById('pubStrainList').appendChild(opt);

			availableTags.push( { label:hostSourceTableJson.data[i].value, value:hostSourceTableJson.data[i].feature_id } );
		}
		$("#autoComp").autocomplete({
			source: availableTags,
			select: function( event, ui ) {
				$("#autoComp").val( ui.item.label );
				$("#autoComp_hidden").val( ui.item.value );
				return false;
			}
		});
		$('#pubStrainInfoDropdown').show();
		$('#pubStrainInfoSearch').show();
		$('#strainInfoProgressbar').hide()
	});
});

$('#isolationDateView').click( function() {
	$('#pubStrainInfoDropdown').hide();
	$('#pubStrainInfoSearch').hide();
	$('#strainInfoProgressbar').show()
	$.ajax({
		type: "POST",
		url: "/isolation_date_form",
		data: { public_id_list: featureIdList }
	}).done(function (returned_data) {
		var hostSourceTableJsonString = returned_data;
		var hostSourceTableJson = $.parseJSON(hostSourceTableJsonString);
		console.log(hostSourceTableJson);
		var availableTags = [];
		$('#pubStrainList').empty();

		for (i=0 ; i<hostSourceTableJson.data.length ; i++) {
			var opt = document.createElement("option");
			var description = document.createTextNode(hostSourceTableJson.data[i].value);
			opt.value = hostSourceTableJson.data[i].feature_id;
			opt.appendChild(description);
			document.getElementById('pubStrainList').appendChild(opt);

			availableTags.push( { label:hostSourceTableJson.data[i].value, value:hostSourceTableJson.data[i].feature_id } );
		}
		$("#autoComp").autocomplete({
			source: availableTags,
			select: function( event, ui ) {
				$("#autoComp").val( ui.item.label );
				$("#autoComp_hidden").val( ui.item.value );
				return false;
			}
		});
		$('#pubStrainInfoDropdown').show();
		$('#pubStrainInfoSearch').show();
		$('#strainInfoProgressbar').hide()
	});
});

$('#isolationLocationView').click( function() {
	$('#pubStrainInfoDropdown').hide();
	$('#pubStrainInfoSearch').hide();
	$('#strainInfoProgressbar').show()
	$.ajax({
		type: "POST",
		url: "/isolation_location_form",
		data: { public_id_list: featureIdList }
	}).done(function (returned_data) {
		var hostSourceTableJsonString = returned_data;
		var hostSourceTableJson = $.parseJSON(hostSourceTableJsonString);
		console.log(hostSourceTableJson);
		var availableTags = [];
		$('#pubStrainList').empty();

		for (i=0 ; i<hostSourceTableJson.data.length ; i++) {
			var opt = document.createElement("option");
			var description = document.createTextNode(hostSourceTableJson.data[i].value);
			opt.value = hostSourceTableJson.data[i].feature_id;
			opt.appendChild(description);
			document.getElementById('pubStrainList').appendChild(opt);

			availableTags.push( { label:hostSourceTableJson.data[i].value, value:hostSourceTableJson.data[i].feature_id } );
		}
		$("#autoComp").autocomplete({
			source: availableTags,
			select: function( event, ui ) {
				$("#autoComp").val( ui.item.label );
				$("#autoComp_hidden").val( ui.item.value );
				return false;
			}
		});
		$('#pubStrainInfoDropdown').show();
		$('#pubStrainInfoSearch').show();
		$('#strainInfoProgressbar').hide()
	});
});

});

</script>

</body>

<TMPL_INCLUDE NAME="footer.tmpl">

</html>