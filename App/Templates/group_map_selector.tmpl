<script type="text/javascript" src="/App/Styling/js/markerclusterer.js"></script>

<div style="margin:10px">
	<p style="margin-bottom: 40px">
		Select multiple strains from the map. As you zoom in and out and pan accross the map the list of markers on the right will change.
	</p>
	<div style="padding: 0 10px 0 10px">
		<hr/>
	</div>
</div>

<table>
	<tbody>
		<tr>
			<td>
			</td>
			<td>
				<div class="span4">
					<div class="btn-group btn-group-vertical">
						<button id="buttonMapGroup1" class="btn btn-primary" type="button"><i class="icon-arrow-right icon-white"></i> Add to Group 1</button>
						<button id="buttonMapGroup2" class="btn btn-primary" type="button"><i class="icon-arrow-right icon-white"></i> Add to Group 2</button>
					</div>
					<div id="map-meta-form" style="padding-top:20px; padding-left:0px;" >
					</div>
					<script type="text/javascript">
					buildMetaForm("#map-meta-form","map");
					</script>
				</div>
			</td>
		</tr>
		<tr>
			<td>
				<div class="span7">			
					<form class="form-inline">
						<fieldset>
							<input id="multiMaplocation" class="span6" type="text" placeholder="Search for a location">
							<button type="button" class="btn" onclick="codeMultiMapAddress()">Search</button>
						</fieldset>
					</form>
				</div>
				<div class="span7" id="multi-map-canvas" style="height:300px"></div>
			</td>
			<td>
				<div class="span4" style="border:solid;border-width:1px;border-color:#d3d3d3;max-height:300px;overflow:auto">
					<form id="strainListForm" class="form" action="/group_wise_comparisons/" method="post" enctype="application/x-www-form-urlencoded">
						<div style="padding:10px">
							<fieldset>
								<span class="help-block"></span>
								<ul id="multiMapStrainList" style="padding:0px;margin:0px">
									<li style="list-style:none">
									</li>
								</ul>
							</fieldset>
						</form>
					</div>
				</div>
			</td>
		</tr>
	</tbody>
</table>

<script type="text/javascript">

//This disables the enter key from submitting the form to an empty url
$(function(){
	$("#multiMaplocation").keypress(function(e){
		var k=e.keyCode || e.which;
		if(k==13){
			e.preventDefault();
		}
	});
});

var multiMap;
var multiMarkers = [];
var geocoder;

function initialize() {
	geocoder = new google.maps.Geocoder();
	var mapOptions = {
		center: new google.maps.LatLng(-0.000, 0.000),
		zoom: 1,
		streetViewControl: false,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};

	multiMap = new google.maps.Map(document.getElementById("multi-map-canvas"),
		mapOptions);


	$.post('/map_multi_markers', function(data) {
		var markerList = JSON.parse(data);
		for (var i = 0; i < markerList.data.length; i++) {
			var centerLatLng = new google.maps.LatLng(markerList.data[i].center.lat, markerList.data[i].center.lng);
			var multiMarker = new google.maps.Marker({
				map: multiMap,
				position: centerLatLng,
					//animation: google.maps.Animation.DROP,
					title: markerList.data[i].location,
					feature_id: markerList.data[i].feature_id,
					genome_name: markerList.data[i].genome_name
				});
			multiMarkers.push(multiMarker);
		}
		var mcOptions = {gridSize: 50, maxZoom: 15};
		var mc = new MarkerClusterer(multiMap, multiMarkers, mcOptions);
		populateMultiStrainList(markerList);
	});

	reLoadMap();

}

function reLoadMap() {

	geocoder = new google.maps.Geocoder();
	var mapOptions = {
		center: new google.maps.LatLng(-0.000, 0.000),
		zoom: 1,
		streetViewControl: false,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};

	multiMap = new google.maps.Map(document.getElementById("multi-map-canvas"),
		mapOptions);

	var mcOptions = {gridSize: 50, maxZoom: 15};
	var mc = new MarkerClusterer(multiMap, multiMarkers, mcOptions)
	rePopulateMultiStrainList(multiMarkers);

	google.maps.event.addListener(multiMap, 'bounds_changed', function() {
		var visibleMarkers = [];
		for (var i = 0; i < multiMarkers.length; i++) {
			if(multiMap.getBounds().contains(multiMarkers[i].getPosition())){
				visibleMarkers.push(multiMarkers[i]);
			}
			else{
			}
		}
		updateSelectionList(visibleMarkers);
	});
}

function codeMultiMapAddress() {
	var address = document.getElementById('multiMaplocation').value;
	geocoder.geocode( { 'address': address}, function(results, status) {
		if (status == google.maps.GeocoderStatus.OK) {
			multiMap.setCenter(results[0].geometry.location);
			multiMap.fitBounds(results[0].geometry.viewport);
		}
		else {
			alert('Location ' + document.getElementById('location').value + ' could not be found. Please enter a proper location');
		}
	});
}

function populateMultiStrainList(markerList) {
	for (var i = 0; i < markerList.data.length; i++) {
		$('#multiMapStrainList li').append('<label class="checkbox"><input id="checkboxName" class="checkbox" type="checkbox" value='+markerList.data[i].feature_id+' name="groupWiseStrainNames">'+markerList.data[i].location+' - '+markerList.data[i].genome_name+'</input></label>');
	}
}

function updateSelectionList(visibleMarkers) {
	$('#multiMapStrainList li').empty()
	for (var i = 0; i < visibleMarkers.length; i++) {
		$('#multiMapStrainList li').append('<label class="checkbox"><input id="checkboxName" class="checkbox" type="checkbox" value='+visibleMarkers[i].feature_id+' name="groupWiseStrainNames">'+visibleMarkers[i].title+' - '+visibleMarkers[i].genome_name+'</input></label>');
	}
}

function rePopulateMultiStrainList(multiMarkers) {
	$('#multiMapStrainList li').empty();
	for (var i = 0; i < multiMarkers.length; i++) {
		$('#multiMapStrainList li').append('<label class="checkbox"><input id="checkboxName" class="checkbox" type="checkbox" value='+multiMarkers[i].feature_id+' name="groupWiseStrainNames">'+multiMarkers[i].location+' - '+multiMarkers[i].genome_name+'</input></label>');
	}
}

google.maps.event.addDomListener(window, 'load', initialize);

$('a[href="#map_search_tab"]').click( function(){
	setTimeout("reLoadMap()", 0);
	//initializeMap(); 
});

</script>