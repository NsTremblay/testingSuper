<!DOCTYPE html>
<html>

<head>

	<TMPL_INCLUDE NAME="header.tmpl">

	<link rel="stylesheet" href="/App/Styling/css/genodo_tree.css">
	<link rel="stylesheet" href="/App/Styling/css/jquery-ui-1.10.3.custom.css">
	<script src="/App/Styling/js/jquery-1.9.1.js"></script>
	<script src="/App/Styling/js/jquery-ui-1.10.3.custom.js"></script>
	<script src="/App/Styling/js/d3.v3/d3.v3.min.js"></script>
	
	<script>
	var public_genomes = <TMPL_VAR public_genomes>;
	var private_genomes = <TMPL_VAR private_genomes>;
	var root = null,
	visableData = ['name'];
	</script>
	
	<style type="text/css">
	#pubStrainList li, #tree-selected-genomes li {
		list-style:none;
	}
	#pubStrainList label.listSelected {
		font-weight:bold;
		font-style:italic;
		fill: #796e6c;
	}
	#pubStrainList input.listSelected {
		display:none;
	}
	</style>
	
	<script src="/App/Styling/js/genodo_tree_functions.js"></script>
	<script src="/App/Styling/js/genodo_groupwise_form_functions.js"></script>
	<script src="/App/Styling/js/genodo_boolean_search.js"></script>
	
	<TMPL_INCLUDE NAME="genome_attribute_search_header.tmpl">
	
</head>

<TMPL_INCLUDE NAME="nav_bar_group_wise.tmpl">

<body style="background-color:#796e6c">
	<div class="container" style="background-color:#FFFFFF; padding:20px;">

		<div class="row-fluid">
			<div class="span12">
				<div style="margin:10px 10px 10px 10px; padding:10px 10px 10px 0"><h1><span>GROUPWISE</span> <span style="color:#d41616">COMPARISIONS</span></h1></div>
				<TMPL_IF comparison_failed>
				<div id='group_comparison_error' class="text-error" style="margin:0px 10px 10px 10px"><strong>Failed!</strong> unable to perform genome comparison (error: <TMPL_VAR comparison_failed> )</div>
				</TMPL_IF>
				<span class="help-block" style="margin:0 10px 40px 0">Add one or more genomes from the form below to each comparison group. You can perform groupwise comparisons of your selected genomes for the presence/absence of genomic loci 
					and SNPs identified by the PanSeq analysis platform.</span>
				</div>
			</div>

			<div class="row-fluid">
				<div class="span12">
					<form id="groupedForm" class="form" method="post" action="/group-wise-comparisons/comparison/" enctype="application/x-www-form-urlencoded">
						<div class="span4 offset1" style="border:solid;border-width:1px;border-color:#d3d3d3;padding:10px;max-height:400px">
							<div id="comparison-group1" style="max-height:350px;overflow:auto">
								<fieldset>
									<span class="help-block">Group 1: </span>
								</fieldset>
							</div>
							<button id="buttonRemoveGroup1" class="btn btn-primary btn-small" type="button" style="display:none;margin:5px 0px 0px 0px"><i class="icon-arrow-left icon-white"></i> Remove from Group 1</button>
						</div>

						<div class="span4" style="border:solid;border-width:1px;border-color:#d3d3d3;padding:10px;max-height:400px">
							<div id="comparison-group2" style="max-height:350px;overflow:auto">
								<fieldset>
									<span class="help-block">Group 2: </span>
								</fieldset>
							</div>
							<button id="buttonRemoveGroup2" class="btn btn-primary btn-small" type="button" style="display:none;margin:5px 0px 0px 0px"><i class="icon-arrow-left icon-white"></i> Remove from Group 2</button>
						</div>
					</form>
				</div>
			</div>

			<div class="row-fluid">
				<div class="span4 offset1">
					<div style="margin: 20px 0 40px 0; display: inline-block;">
						<button id="compareGrouped" class="btn btn-primary" type="button" value="Submit"><i class="icon-th icon-white"></i> Compare Groups</button>
						<button id="reset" class="btn btn-danger" type="reset" onclick="history.go(0)" value="Reset"><i class="icon-refresh icon-white"></i> Reset</button>
					</div>
				</div>
			</div>

			<div class="row-fluid">
				<div class="span12">
					<ul id="groupwise_search_tabs" class="nav nav-tabs">
						<li class="active"><a href="#list_search_tab" data-toggle="tab">Genome List</a></li>
						<li><a href="#phylo_search_tab" data-toggle="tab">Phylogenetic Tree</a></li>
						<li><a href="#map_search_tab" data-toggle="tab">Map</a></li>
						<li><a href="#meta_search_tab" data-toggle="tab">Genome Attributes</a></li>
					</ul>
				</div>
			</div>

			<div class="tab-content">

				<div class="tab-pane active" id="list_search_tab">
					<div class="row-fluid">
						<div class="span6" style="border:solid;border-width:1px;border-color:#d3d3d3;max-height:440px;overflow:auto">

							<form id="strainListForm" class="form">
								<div style="padding:10px">
									<fieldset>
										<span class="help-block"></span>

										<ul id="pubStrainList" style="padding:0px; margin:0px"></ul>
									</fieldset>
								</div>
							</form>
						</div>
						<div class="span6">

							<div class="btn-group btn-group-vertical" style="margin: 20px; display: inline-block;">					
								<button id="buttonGroup1" class="btn btn-primary" type="button"><i class="icon-arrow-right icon-white"></i> Add to Group 1</button>
								<button id="buttonGroup2" class="btn btn-primary" type="button"><i class="icon-arrow-right icon-white"></i> Add to Group 2</button>
							</div>

							<div id="list-meta-form" style="padding-top:20px; padding-left:20px;" >
							</div>

							<script type="text/javascript">
							buildMetaForm("#list-meta-form","list");
							</script>

						</div>
					</div>
				</div>

				<div class="tab-pane" id="phylo_search_tab">

					<div class="row-fluid" style="padding: 10px 0px 50px 0">
						<div class="span12">
							Select genomes by clicking on nodes in the phylogenetic tree.
						</div>
						<div class="span4" style="border:solid; border-width:1px; border-color:#d3d3d3; height:120px; overflow:auto; margin: 10px 0 0 20px;">

							<form id="strainTreeForm" class="form">
								<div>
									<fieldset>
										<span class="help-block"></span>

										<ul id="tree-selected-genomes" style="padding:0px; margin:0px"></ul>
									</fieldset>
								</div>
							</form>
						</div>

						<div class="span6">
							<div class="btn-group btn-group-vertical" style="margin: 20px; display: inline-block;">					
								<button id="buttonTreeGroup1" class="btn btn-primary" type="button"><i class="icon-arrow-right icon-white"></i> Add to Group 1</button>
								<button id="buttonTreeGroup2" class="btn btn-primary" type="button"><i class="icon-arrow-right icon-white"></i> Add to Group 2</button>
							</div>
						</div>
					</div>

					<div class="row-fluid">	
						<div class="span5" id="legend">
							<p>Phylogenetic tree functions</p>

							<script type="text/javascript">
							legend();
							</script>
						</div>

						<div id="tree-meta-form" class="span5" style="padding-top:10px;">
						</div>

						<script type="text/javascript">
						buildMetaForm("#tree-meta-form","tree");
						</script>
					</div>

					<div class="row-fluid">				
						<div id="vis" class="span12">
							<script>
							var smallTreeWindow = false;
							var centreOnSelectedNode = false;
							var multiSelect = true;
							</script>
							<script src="/App/Styling/js/genodo_single_strain_tree_zoom.js"></script>
							<script type="text/javascript">
							root = <TMPL_VAR tree_json>;
							root.x0 = height / 2;
							root.y0 = 0;
							update(root, centreOnSelectedNode, multiSelect);
							</script>
						</div>
					</div>

				</div>	

				<div class="tab-pane" id="map_search_tab">
					<TMPL_INCLUDE NAME="group_map_selector.tmpl">
				</div>

				<div class="tab-pane" id="meta_search_tab">
					<TMPL_INCLUDE NAME="genome_attribute_search.tmpl">
				</div>

			</div>

		</div>
	</div>

</body>

<TMPL_INCLUDE NAME="footer.tmpl">
</html>

<script>

$(function() {

	// Populate forms
	updateMeta('init');
});

$('#buttonGroup1').click(function(event) {
	event.preventDefault();
	
	submitGenomes('genomes-in-list',1);
	
	return false;
});

$('#buttonGroup2').click(function(event) {
	event.preventDefault();
	
	submitGenomes('genomes-in-list',2);
	
	return false;
});

$('#buttonTreeGroup1').click(function(event) {
	event.preventDefault();
	
	var genomeList = {};
	var checked = $("input[name='genomes-in-tree']");
	checked.each( function(i, e) { 
		var id = $( e ).val();
		var genome_data;
		if(/^public_/.test(id)) {
			genome_data = public_genomes[id]
		} else {
			genome_data = private_genomes[id]
		}
		if(typeof genome_data === 'undefined') {
			return "Unrecognized genome";
		}
		var lab = genome_data.uniquename;
		genomeList[id] = lab; 

	});
	
	addToGroup(1, genomeList);
	
	$("#tree-selected-genomes").empty();
	
	return false;
});

$('#buttonTreeGroup2').click(function(event) {
	event.preventDefault();
	
	var genomeList = {};
	var checked = $("input[name='genomes-in-tree']");
	checked.each( function(i, e) { 
		var id = $( e ).val(); 
		var genome_data;
		if(/^public_/.test(id)) {
			genome_data = public_genomes[id]
		} else {
			genome_data = private_genomes[id]
		}
		if(typeof genome_data === 'undefined') {
			return "Unrecognized genome";
		}
		var lab = genome_data.uniquename;
		genomeList[id] = lab;
	});
	
	addToGroup(2, genomeList);
	
	$("#tree-selected-genomes").empty();
	
	return false;
});

$('#buttonMetaGroup1').click(function(event) {
	event.preventDefault();
	
	submitGenomes('genomes-in-attr-search',1);
	
	return false;
});

$('#buttonMetaGroup2').click(function(event) {
	event.preventDefault();
	
	submitGenomes('genomes-in-attr-search',2);
	
	return false;
});

$('#buttonRemoveGroup2').click(function(event) {
	event.preventDefault();
	
	removeFromGroup(2);
	
	return false;
});

$('#buttonRemoveGroup1').click(function(event) {
	event.preventDefault();
	
	removeFromGroup(1);
	
	return false;
});


$('#compareGrouped').click( function(e) {
	e.preventDefault();
	
	$('#groupedForm').submit();
});

$('#groupedForm').submit( function(e) {
	// Check both groups contain 1+ genomes
	var grp1 = $('input[name="comparison-group1-genome"]');
	if(grp1.length < 1) {
		alert('Group 1 currently empty')
		return false;
	}
	
	var grp2 = $('input[name="comparison-group2-genome"]');
	if(grp2.length < 1) {
		alert('Group 2 currently empty')
		return false;
	}
	
	// Prepare inputs
	grp1.prop("checked", true);
	grp2.prop("checked", true);
	
	// submit form
	return true;
});

/*
function checkGroupedFields(groupedForm) {
	if ($('#group1 li').length == 0 && $('#group2 li').length == 0) {
		alert('No groups to be compared');
	}
	else {
		$('#svgCanvas').hide();
		$('#groupWiseDataLink').hide("slow");
		$('#groupWiseData').hide("slow");
		$('#wheel-loader').show();
		$('#group1 input[type=checkbox]').each(function()
		{
			this.checked = true;
		});
		$('#group2 input[type=checkbox]').each(function()
		{
			this.checked = true;
		});
		$('#binaryTableGroup1').empty();
		$('#binaryTableGroup2').empty();
		$('#snpTableGroup1').empty();
		$('#snpTableGroup2').empty();
		$.post("/group_wise_info/" , ($('#group1 input').serialize() + '&' + $('#group2 input').serialize()),
			function(data) {
				$('#wheel-loader').hide();
				//Append binary table head for group1 and 2
				$('#binaryTableGroup1').prepend('<thead>Group 1</thead><tr><th>Locus ID</th><th>Strains Present</th><th>Strains Absent</th><th>p-value</th></tr>');
				//Append binary table body
				for (var i = 0; i < data.data[0].length; i++) {
					$('#binaryTableGroup1').append('<tr><td>'+data.data[0][i].locusname+'</td><td>'+data.data[0][i].present_count+'</td><td>'+data.data[0][i].absent_count+'</td><td>< 0.001</td></tr>');
				};
				$('#binaryTableGroup2').prepend('<thead>Group 2</thead><tr><th>Locus ID</th><th>Strains Present</th><th>Strains Absent</th><th>p-value</th></tr>');
				//Append binary table body
				for (var i = 0; i < data.data[2].length; i++) {
					$('#binaryTableGroup2').append('<tr><td>'+data.data[2][i].locusname+'</td><td>'+data.data[2][i].present_count+'</td><td>'+data.data[2][i].absent_count+'</td><td>< 0.001</td></tr>');
				};
				//Append snp table head
				$('#snpTableGroup1').append('<thead>Group 1</thead><tr><th>SNP ID</th><th>A</th><th>T</th><th>C</th><th>G</th><th>p-value</th></tr>');
				for (var i = 0; i < data.data[1].length; i++) {
					$('#snpTableGroup1').append('<tr><td>'+data.data[1][i].locusname+'</td><td>'+data.data[1][i].adenine_count+'</td><td>'+data.data[1][i].thymidine_count+'</td><td>'+data.data[1][i].cytosine_count+'</td><td>'+data.data[1][i].guanine_count+'</td><td>< 0.001</td></tr>');
				}
				//Append snp table body
				$('#snpTableGroup2').append('<thead>Group 2</thead><tr><th>SNP ID</th><th>A</th><th>T</th><th>C</th><th>G</th><th>p-value</th></tr>');
				for (var i = 0; i < data.data[3].length; i++) {
					$('#snpTableGroup2').append('<tr><td>'+data.data[3][i].locusname+'</td><td>'+data.data[3][i].adenine_count+'</td><td>'+data.data[3][i].thymidine_count+'</td><td>'+data.data[3][i].cytosine_count+'</td><td>'+data.data[3][i].guanine_count+'</td><td>< 0.001</td></tr>');
				}
				$('#svgCanvas').empty();
				$('#svgCanvas').append('<div style="align:middle">'+data.data[4]+'</div>');
				$('#svgCanvas').show("slow");
				$('#groupWiseDataLink').show("slow");
				$('#groupWiseData').show();
				unCheckAllBoxes();

			} , "json");
	}
}
*/
</script>